schedules:
  - cron: '0 18 * * *'
    displayName: Daily 6PM build
    branches:
      include:
        - main
    always: true

trigger:
  branches:
    include:
      - main
  tags:
    include:
      - refs/tags/*

pool:
  vmImage: ubuntu-latest

steps:
  - task: UseNode@1
    inputs:
      version: '20.18.1' # Specify the version of Node.js you want to use
    displayName: 'Use Node.js 20.18.1'

  - bash: |
      /usr/bin/Xvfb :99 -screen 0 3840x2160x24 > /dev/null 2>&1 & echo '>>> Started xvfb'
    displayName: Start xvfb
    condition: and(succeeded(), eq(variables['Agent.OS'], 'Linux'))

  - bash: |
      set -euxo pipefail
      date -u
      lsb_release -a || true

      sudo apt-get update
      sudo apt-get install -y ca-certificates openssl
      sudo update-ca-certificates

      echo "=== What cert do we see for package.elm-lang.org?"
      openssl s_client -connect package.elm-lang.org:443 -servername package.elm-lang.org </dev/null 2>/dev/null \
        | openssl x509 -noout -subject -issuer -dates

      echo "=== curl sanity"
      curl -I --max-time 20 https://package.elm-lang.org/all-packages
    displayName: TLS sanity check (Elm registry)
    condition: and(succeeded(), eq(variables['Agent.OS'], 'Linux'))

  - bash: |
      sudo apt-get update && sudo apt-get install -y build-essential
      git config --global user.email $BUILD_REQUESTEDFOREMAIL
      git config --global user.name "$BUILD_REQUESTEDFOR"
      make test
    displayName: 'Build and test with Make'
    env:
      DISPLAY: ':99.0'

  - bash: |
      npm run compile-web
      ls -la dist/web/extension.js
    displayName: 'Verify web bundle builds'

  # ============================================================================
  # Publishing Steps (only on tagged releases, Linux only)
  # ============================================================================
  # These steps run sequentially. vsce runs FIRST and updates package.json
  # with the tag version (e.g., "1.12.0"). ovsx runs SECOND and reads the
  # already-updated package.json - no version arg needed.
  #
  # Note: vsce supports `vsce publish <version>` to bump package.json inline.
  # ovsx does NOT - its positional arg is a .vsix path, not a version.
  # ============================================================================

  - bash: |
      set -euxo pipefail
      : "${VSCE_PAT:?VSCE_PAT is required}"

      # vsce publish <version> does three things:
      # 1. Updates package.json version to the tag (e.g., 1.12.0)
      # 2. Packages the extension into a .vsix
      # 3. Publishes to VS Code Marketplace
      echo ">>> Publish (VS Marketplace)"
      npm run deploy:vsmarketplace -- $(Build.SourceBranchName)
    displayName: Publish (VS Marketplace)
    condition: and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/tags/'), eq(variables['Agent.OS'], 'Linux'))
    env:
      VSCE_PAT: $(VSCE_PAT)
      HUSKY: 0

  - bash: |
      set -euxo pipefail
      : "${OPEN_VSX_TOKEN:?OPEN_VSX_TOKEN is required}"

      # No version arg needed! vsce (above) already updated package.json.
      # ovsx reads the version from package.json automatically.
      echo ">>> Publish (Open VSX)"
      npm run deploy:ovsx
    displayName: Publish (Open VSX)
    condition: and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/tags/'), eq(variables['Agent.OS'], 'Linux'))
    env:
      OPEN_VSX_TOKEN: $(OPEN_VSX_TOKEN)
      HUSKY: 0
