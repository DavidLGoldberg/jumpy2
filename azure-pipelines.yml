schedules:
  - cron: '0 18 * * *'
    displayName: Daily 6PM build
    branches:
      include:
        - main
    always: true

trigger:
  branches:
    include:
      - main
  tags:
    include:
      - refs/tags/*

pool:
  vmImage: ubuntu-latest

steps:
  - task: UseNode@1
    inputs:
      version: '20.18.1' # Specify the version of Node.js you want to use
    displayName: 'Use Node.js 20.18.1'

  - bash: |
      /usr/bin/Xvfb :99 -screen 0 3840x2160x24 > /dev/null 2>&1 & echo '>>> Started xvfb'
    displayName: Start xvfb
    condition: and(succeeded(), eq(variables['Agent.OS'], 'Linux'))

  - bash: |
      set -euxo pipefail
      date -u
      lsb_release -a || true

      sudo apt-get update
      sudo apt-get install -y ca-certificates openssl
      sudo update-ca-certificates

      echo "=== What cert do we see for package.elm-lang.org?"
      openssl s_client -connect package.elm-lang.org:443 -servername package.elm-lang.org </dev/null 2>/dev/null \
        | openssl x509 -noout -subject -issuer -dates

      echo "=== curl sanity"
      curl -I --max-time 20 https://package.elm-lang.org/all-packages
    displayName: TLS sanity check (Elm registry)
    condition: and(succeeded(), eq(variables['Agent.OS'], 'Linux'))

  - bash: |
      sudo apt-get update && sudo apt-get install -y build-essential
      git config --global user.email $BUILD_REQUESTEDFOREMAIL
      git config --global user.name "$BUILD_REQUESTEDFOR"
      make test
    displayName: 'Build and test with Make'
    env:
      DISPLAY: ':99.0'

  - bash: |
      echo ">>> Publish"
      npm run deploy -- $(Build.SourceBranchName)
    displayName: Publish
    condition: and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/tags/'), eq(variables['Agent.OS'], 'Linux'))
    env:
      VSCE_PAT: $(VSCE_PAT)
      HUSKY: 0
